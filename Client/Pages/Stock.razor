@page "/stock"
@using Pampazon.Web.Client.Models
@using Pampazon.Web.Client.Components // Added for form
@inject HttpClient Http
@inject NavigationManager NavigationManager // For potential navigation after actions

<h3>Current Stock</h3>

@if (!string.IsNullOrEmpty(loadErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @loadErrorMessage
    </div>
}

@if (showStockPositionForm)
{
    <StockPositionForm StockPositionModel="currentStockPosition" IsEdit="isEditMode" OnSubmit="HandleStockPositionSubmit" OnCancel="CancelStockPositionForm" />
}
else
{
    if (stockPositions == null && string.IsNullOrEmpty(loadErrorMessage))
    {
        <p><em>Loading...</em></p>
    }
    else if (stockPositions != null && !stockPositions.Any())
    {
        <p><em>No stock positions found.</em></p>
    }
    else if (stockPositions != null)
    {
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Product ID</th> @* Changed from Product Code *@
                    <th>Product Desc.</th>
                    <th>Client ID</th>
                    <th>Receipt #</th> @* Added ReceiptNumber column *@
                    <th>Qty</th>
                    <th>Position</th>
                    <th>Created At</th> @* Added CreatedAt column *@
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var stockItem in stockPositions)
                {
                    <tr>
                        <td>@stockItem.Id</td>
                        <td>@stockItem.ProductId</td> @* Changed from ProductCode *@
                        <td>@(stockItem.Product?.Description ?? "N/A")</td>
                        <td>@stockItem.ClientId</td>
                        <td>@stockItem.ReceiptNumber</td> @* Added ReceiptNumber data *@
                        <td>@stockItem.Quantity</td>
                        <td>@stockItem.GetPositionCode()</td>
                        <td>@stockItem.CreatedAt.ToShortDateString()</td> @* Added CreatedAt data *@
                        <td>
                            @* View details could be a modal or separate page later *
                            @* <button class="btn btn-sm btn-info" @onclick="() => ViewStockPositionDetails(stockItem)">View</button> *@
                            <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDeleteStockPosition(stockItem.Id)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    <button class="btn btn-success mt-3" @onclick="ShowCreateStockPositionForm">Add New Stock Position</button>
}

@code {
    private List<StockPosition>? stockPositions;
    private string? loadErrorMessage;

    // For form handling
    private bool showStockPositionForm = false;
    private StockPosition currentStockPosition = new();
    private bool isEditMode = false; // Not used for now, but good for future

    private const string ApiBaseUrl = "api/Stock"; // Changed from "api/stock"

    protected override async Task OnInitializedAsync()
    {
        await LoadStockPositions();
    }

    private async Task LoadStockPositions()
    {
        loadErrorMessage = null;
        try
        {
            stockPositions = await Http.GetFromJsonAsync<List<StockPosition>>(ApiBaseUrl);
        }
        catch (HttpRequestException httpEx)
        {
            loadErrorMessage = $"HTTP Error loading stock: {httpEx.Message} (Status: {httpEx.StatusCode})";
            stockPositions = new List<StockPosition>();
        }
        catch (Exception ex)
        {
            loadErrorMessage = $"An error occurred loading stock: {ex.Message}";
            stockPositions = new List<StockPosition>();
            Console.WriteLine($"Error loading stock positions: {ex}");
        }
        StateHasChanged();
    }

    private void ShowCreateStockPositionForm()
    {
        currentStockPosition = new StockPosition(); // Initialize a new model for the form
        // CreatedAt will be set by backend or in form's OnInitialized if needed by frontend before send
        isEditMode = false;
        showStockPositionForm = true;
    }

    private void CancelStockPositionForm()
    {
        showStockPositionForm = false;
        currentStockPosition = new();
    }

    private async Task HandleStockPositionSubmit(StockPosition stockPositionToSubmit)
    {
        // For now, only create is implemented here. Edit would use PUT.
        if (!isEditMode)
        {
            var response = await Http.PostAsJsonAsync(ApiBaseUrl, stockPositionToSubmit);
            if (response.IsSuccessStatusCode)
            {
                await LoadStockPositions(); // Refresh list
            }
            else
            {
                loadErrorMessage = $"Error creating stock position: {await response.Content.ReadAsStringAsync()}";
                Console.WriteLine($"Error creating stock position: {response.ReasonPhrase} - {await response.Content.ReadAsStringAsync()}");
            }
        }
        showStockPositionForm = false;
        StateHasChanged();
    }

    private async Task ConfirmDeleteStockPosition(int stockPositionId)
    {
        // Consider adding a JS confirm dialog here for better UX
        // if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this stock position?"))
        // {
        try
        {
            var response = await Http.DeleteAsync($"{ApiBaseUrl}/{stockPositionId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadStockPositions(); // Refresh the list
            }
            else
            {
                loadErrorMessage = $"Error deleting stock position {stockPositionId}: {await response.Content.ReadAsStringAsync()}";
                Console.WriteLine(loadErrorMessage);
                StateHasChanged(); // Update UI with error message
            }
        }
        catch (Exception ex)
        {
            loadErrorMessage = $"Exception deleting stock position {stockPositionId}: {ex.Message}";
            Console.WriteLine(loadErrorMessage);
            StateHasChanged(); // Update UI with error message
        }
        // }
    }

    // private void ViewStockPositionDetails(StockPosition stockPosition)
    // {
    //     // TODO: Logic to show details of the stock position
    //     Console.WriteLine($"Viewing stock position ID: {stockPosition.Id}");
    // }
} 